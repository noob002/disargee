<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE MINORITY: FINAL PROTOCOL</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --main-color: #33ff33; /* 초기 초록색 */
            --danger-color: #ff3333; /* 위험 빨간색 */
            --bg-color: #050505;
        }

        body {
            background-color: #000;
            color: var(--main-color);
            font-family: 'VT323', monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            text-transform: uppercase;
            user-select: none;
            transition: 0.5s;
        }

        /* 위험 모드 (빨간색 테마) */
        body.red-mode {
            --main-color: var(--danger-color);
        }

        .crt-frame {
            border: 4px solid var(--main-color);
            padding: 30px;
            width: 700px;
            max-width: 95%;
            height: 550px;
            box-shadow: 0 0 20px var(--main-color), inset 0 0 50px rgba(0,0,0,0.8);
            background-color: var(--bg-color);
            position: relative;
            display: flex;
            flex-direction: column;
            transition: border-color 0.5s, box-shadow 0.5s;
        }

        /* 스캔라인 효과 */
        .scanline {
            width: 100%;
            height: 100px;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255, 255, 255, 0.03) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 6s linear infinite;
            pointer-events: none;
            z-index: 999;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }

        /* UI 공통 */
        .header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid var(--main-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
        }

        /* 버튼 스타일 */
        button {
            background: transparent;
            border: 2px solid var(--main-color);
            color: var(--main-color);
            font-family: 'VT323', monospace;
            font-size: 1.8rem;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px;
            transition: 0.2s;
        }
        button:hover { background-color: var(--main-color); color: #000; }

        /* PHASE 1: 소수결 */
        #screen-phase1 { display: none; width: 100%; text-align: center; }
        .question-text { font-size: 2rem; min-height: 80px; margin-bottom: 30px; }
        .result-bar-bg { width: 100%; height: 20px; background: #111; border: 1px solid var(--main-color); margin-top: 20px; display: none; }
        .result-bar-fill { height: 100%; background: var(--main-color); width: 0%; transition: width 0.5s; }

        /* PHASE 2: 해킹 */
        #screen-phase2 { display: none; width: 100%; text-align: center; }
        .code-box { font-size: 4rem; letter-spacing: 15px; margin: 20px 0; border: 2px dashed var(--main-color); padding: 20px; }
        .hack-input { background: transparent; border: none; border-bottom: 3px solid var(--main-color); color: var(--main-color); font-size: 2.5rem; text-align: center; width: 80%; outline: none; text-transform: uppercase; }
        .timer-bg { width: 100%; height: 10px; background: #330000; margin-top: 30px; }
        .timer-fill { width: 100%; height: 100%; background: #ff3333; }

        /* PHASE 3: 탄막 회피 (DODGE) */
        #screen-phase3 { display: none; width: 100%; height: 100%; text-align: center; }
        canvas {
            border: 2px solid var(--main-color);
            background: #000;
            cursor: none; /* 마우스 커서 숨김 */
            display: block;
            margin: 0 auto;
        }
        .survival-timer {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ff3333;
        }

        /* END SCREEN */
        #screen-end { display: none; text-align: center; }
        .big-msg { font-size: 4rem; margin: 0; }

        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div class="scanline"></div>

    <div class="crt-frame">
        <div class="header">
            <span>LEVEL: <span id="stage-display">WAITING</span></span>
            <span>STATUS: <span id="status-display">OK</span></span>
        </div>

        <div class="content-area">
            <div id="screen-start" style="text-align: center;">
                <h1 style="font-size: 3rem;">THE MINORITY</h1>
                <p>3단계의 테스트를 통과하십시오.</p>
                <button onclick="startPhase1()" class="blink">SYSTEM START</button>
            </div>

            <div id="screen-phase1">
                <div class="question-text" id="p1-text"></div>
                <div id="p1-btns" style="display: flex; gap: 20px; justify-content: center;">
                    <button onclick="checkP1(true)">[Y] AGREE</button>
                    <button onclick="checkP1(false)">[N] DISAGREE</button>
                </div>
                <div id="p1-result">
                    <div class="result-bar-bg" id="bar-bg"><div class="result-bar-fill" id="bar-fill"></div></div>
                    <p id="p1-msg" style="margin-top:15px; height: 30px;"></p>
                    <button id="next-btn" onclick="nextPhase1()" style="display:none; width:100%;">NEXT >></button>
                </div>
            </div>

            <div id="screen-phase2">
                <h2 class="blink" style="color: #ff3333;">⚠ SECURITY BREACH ⚠</h2>
                <div class="code-box" id="p2-code">????</div>
                <input type="text" class="hack-input" id="p2-input" placeholder="TYPE CODE" onkeyup="checkP2(event)" autocomplete="off">
                <div class="timer-bg"><div class="timer-fill" id="p2-timer"></div></div>
                <p id="p2-info">DEFENSE: 0 / 3</p>
            </div>

            <div id="screen-phase3">
                <div class="survival-timer">TIME: <span id="dodge-timer">READY</span></div>
                <canvas id="gameCanvas" width="600" height="350"></canvas>
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">MOUSE TO MOVE / AVOID RED BLOCKS</p>
            </div>

            <div id="screen-end">
                <h1 class="big-msg" id="end-title">GAME OVER</h1>
                <p id="end-desc">REASON: ...</p>
                <button onclick="location.reload()" style="margin-top: 30px;">REBOOT</button>
            </div>
        </div>
    </div>

    <script>
        /* ================= GAME LOGIC ================= */
        
        function showScreen(id) {
            ['screen-start','screen-phase1','screen-phase2','screen-phase3','screen-end']
                .forEach(s => document.getElementById(s).style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        // --- PHASE 1: 소수결 ---
        const questions = [
            { q: "비 오는 날이 맑은 날보다 좋다.", rate: 80 }, 
            { q: "10억 받기 vs 말하는 고양이 키우기", rate: 20 },
            { q: "솔직히 탕수육은 부먹이다.", rate: 45 },
        ];
        let p1Idx = 0;

        function startPhase1() {
            showScreen('screen-phase1');
            document.getElementById('stage-display').innerText = "1 - MINORITY";
            renderP1();
        }

        function renderP1() {
            const q = questions[p1Idx];
            document.getElementById('p1-text').innerText = q.q;
            document.getElementById('p1-btns').style.display = 'flex';
            document.getElementById('bar-bg').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('p1-msg').innerText = "";
            document.getElementById('bar-fill').style.width = "0%";
        }

        function checkP1(agree) {
            const q = questions[p1Idx];
            const rate = agree ? q.rate : (100 - q.rate);
            
            document.getElementById('p1-btns').style.display = 'none';
            document.getElementById('bar-bg').style.display = 'block';
            setTimeout(() => document.getElementById('bar-fill').style.width = rate + "%", 50);

            if (rate < 50) {
                document.getElementById('p1-msg').innerText = `생존. 소수(${rate}%)입니다.`;
                document.getElementById('next-btn').style.display = 'inline-block';
            } else {
                failGame("MAJORITY DETECTED", "당신은 다수에 속했습니다.");
            }
        }

        function nextPhase1() {
            p1Idx++;
            if (p1Idx >= questions.length) startPhase2();
            else renderP1();
        }

        // --- PHASE 2: 해킹 ---
        let p2Score = 0;
        let p2TimerInterval;
        let p2Time = 100;

        function startPhase2() {
            document.body.classList.add('red-mode');
            document.getElementById('stage-display').innerText = "2 - HACKING";
            document.getElementById('status-display').innerText = "WARNING";
            showScreen('screen-phase2');
            nextP2();
        }

        function nextP2() {
            if (p2Score >= 3) {
                clearInterval(p2TimerInterval);
                startPhase3();
                return;
            }
            
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let code = "";
            for(let i=0; i<4; i++) code += chars.charAt(Math.floor(Math.random()*chars.length));
            
            document.getElementById('p2-code').innerText = code;
            document.getElementById('p2-input').value = "";
            document.getElementById('p2-input').focus();

            p2Time = 100;
            clearInterval(p2TimerInterval);
            p2TimerInterval = setInterval(() => {
                p2Time -= 1.5;
                document.getElementById('p2-timer').style.width = p2Time + "%";
                if (p2Time <= 0) {
                    clearInterval(p2TimerInterval);
                    failGame("SYSTEM HACKED", "방화벽이 뚫렸습니다.");
                }
            }, 50);
        }

        function checkP2(e) {
            if (e.key === "Enter") {
                const target = document.getElementById('p2-code').innerText;
                const input = document.getElementById('p2-input').value.toUpperCase();
                if (target === input) {
                    p2Score++;
                    document.getElementById('p2-info').innerText = `DEFENSE: ${p2Score} / 3`;
                    nextP2();
                } else {
                    document.getElementById('p2-input').value = ""; 
                }
            }
        }

        // --- PHASE 3: 탄막 회피 (카운트다운 추가) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameLoopId;
        let p3TimeLeft = 15.00;
        let enemies = [];
        let player = { x: 300, y: 175, size: 10, color: '#33ff33' };
        
        // 상태 변수: 'ready' (카운트다운) 또는 'playing' (게임중)
        let gameState = 'ready'; 
        let countdownNum = 3; 

        function startPhase3() {
            showScreen('screen-phase3');
            document.getElementById('stage-display').innerText = "3 - SURVIVAL";
            document.getElementById('status-display').innerText = "CRITICAL";

            // 변수 초기화
            enemies = [];
            p3TimeLeft = 15.00;
            gameState = 'ready';
            countdownNum = 3;
            document.getElementById('dodge-timer').innerText = "READY...";

            // 마우스 이벤트 (카운트다운 중에도 움직일 수 있음)
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                player.x = e.clientX - rect.left;
                player.y = e.clientY - rect.top;
            });

            // 카운트다운 로직
            const countInterval = setInterval(() => {
                if (countdownNum > 0) {
                    document.getElementById('dodge-timer').innerText = `START IN ${countdownNum}...`;
                    countdownNum--;
                } else {
                    clearInterval(countInterval);
                    gameState = 'playing'; // 게임 시작
                }
            }, 1000);

            // 게임 루프 시작
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function spawnEnemy() {
            // [쉬움 난이도 유지]
            if (Math.random() < 0.08) { 
                enemies.push({
                    x: Math.random() * canvas.width,
                    y: -20,
                    size: Math.random() * 20 + 10,
                    speed: Math.random() * 3 + 1, // 느린 속도
                    color: '#ff3333'
                });
            }
            if (Math.random() < 0.015) {
                enemies.push({
                    x: -20,
                    y: Math.random() * canvas.height,
                    size: 15,
                    speedX: Math.random() * 3 + 2, 
                    speedY: 0,
                    color: '#ff3333',
                    type: 'side'
                });
            }
        }

        function gameLoop() {
            // 1. 화면 지우기 (잔상 효과)
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. 플레이어 그리기 (항상 표시 - 준비 시간에도 보임)
            ctx.fillStyle = player.color;
            ctx.shadowBlur = 10;
            ctx.shadowColor = player.color;
            ctx.fillRect(player.x - player.size/2, player.y - player.size/2, player.size, player.size);
            ctx.shadowBlur = 0;

            // --- 준비 상태일 때 ---
            if (gameState === 'ready') {
                // 중앙에 큰 카운트다운 숫자 표시 (선택사항)
                ctx.fillStyle = "#ffffff";
                ctx.font = "40px VT323";
                ctx.textAlign = "center";
                ctx.fillText(countdownNum > 0 ? countdownNum : "GO!", canvas.width/2, canvas.height/2);
                
                // 루프 계속 (플레이어 움직임 갱신을 위해)
                gameLoopId = requestAnimationFrame(gameLoop);
                return; // 적 생성 안 함
            }

            // --- 게임 진행 상태일 때 ---
            
            // 타이머 감소
            p3TimeLeft -= 0.016;
            document.getElementById('dodge-timer').innerText = p3TimeLeft.toFixed(2);

            if (p3TimeLeft <= 0) {
                cancelAnimationFrame(gameLoopId);
                gameClear();
                return;
            }

            // 적 생성 및 이동
            spawnEnemy();

            for (let i = 0; i < enemies.length; i++) {
                let e = enemies[i];
                if (e.type === 'side') e.x += e.speedX;
                else e.y += e.speed;

                ctx.fillStyle = e.color;
                ctx.fillRect(e.x, e.y, e.size, e.size);

                // 충돌 감지
                if (
                    player.x < e.x + e.size &&
                    player.x + player.size > e.x &&
                    player.y < e.y + e.size &&
                    player.y + player.size > e.y
                ) {
                    cancelAnimationFrame(gameLoopId);
                    failGame("KILLED", "공격에 당했습니다.");
                    return;
                }
            }

            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function failGame(title, desc) {
            showScreen('screen-end');
            document.getElementById('end-title').innerText = title;
            document.getElementById('end-title').style.color = "red";
            document.getElementById('end-desc').innerText = desc;
            clearInterval(p2TimerInterval);
            if(gameLoopId) cancelAnimationFrame(gameLoopId);
        }

        function gameClear() {
            showScreen('screen-end');
            document.getElementById('end-title').innerText = "ALL CLEAR";
            document.getElementById('end-title').style.color = "#33ff33";
            document.getElementById('end-desc').innerText = "축하합니다. 당신은 완벽히 생존했습니다.";
            document.body.classList.remove('red-mode');
        }
    </script>
</body>
</html>
