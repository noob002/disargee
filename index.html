<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE MINORITY: ?????? PROTOCOL</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --main-color: #33ff33;
            --bg-color: #050505;
            --rank-bg: rgba(0, 20, 0, 0.95);
        }

        body {
            background-color: #000;
            color: var(--main-color);
            font-family: 'VT323', monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            text-transform: uppercase;
            user-select: none;
            transition: color 1s ease;
        }

        body.mode-green { --main-color: #33ff33; --rank-bg: rgba(0, 20, 0, 0.95); }
        body.mode-yellow { --main-color: #ffcc00; }
        body.mode-red { --main-color: #ff3333; }
        body.mode-break { --main-color: #ffffff; }
        body.mode-clear { --main-color: #00ffff; }
        body.mode-gray { --main-color: #888888; }
        body.mode-nightmare { --main-color: #b026ff; --rank-bg: rgba(20, 0, 20, 0.95); }
        body.mode-chaos { --main-color: #00ffea; text-shadow: 2px 0 #ff00ff; }
        body.mode-coward { --main-color: #cd853f; }

        .crt-frame {
            border: 4px solid var(--main-color);
            padding: 30px;
            width: 700px;
            max-width: 95%;
            height: 550px;
            box-shadow: 0 0 20px var(--main-color), inset 0 0 50px rgba(0,0,0,0.8);
            background-color: var(--bg-color);
            position: relative; 
            display: flex;
            flex-direction: column;
            transition: border-color 0.5s, box-shadow 0.5s;
            z-index: 10;
        }

        .crt-frame.chaos-shake { animation: soft-drift 2s infinite alternate; }
        @keyframes soft-drift { from { transform: translate(0,0); } to { transform: translate(1px, 1px); } }

        .scanline {
            width: 100%; height: 100px;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255, 255, 255, 0.03) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1; position: absolute; bottom: 100%;
            animation: scanline 6s linear infinite; pointer-events: none; z-index: 999;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }

        .header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--main-color); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.4rem; position: relative; }
        .content-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; width: 100%; }

        button {
            background: transparent; border: 2px solid var(--main-color); color: var(--main-color);
            font-family: 'VT323', monospace; font-size: 1.8rem; padding: 10px 20px;
            cursor: pointer; margin: 10px; transition: 0.2s;
        }
        button:hover { background-color: var(--main-color); color: #000; }
        
        #skip-btn { display: none; border-style: dashed; font-size: 1.2rem; margin-top: 10px; opacity: 0.7; }
        #reset-btn { display: inline-block; border-style: dotted; font-size: 1.2rem; margin-top: 10px; color: #ff3333; border-color: #ff3333; }
        #reset-btn:hover { background: #ff3333; color: #000; }
        
        #nightmare-btn {
            display: none; border: 2px solid #b026ff; color: #b026ff; margin-top: 20px;
            animation: pulse 1s infinite; font-weight: bold;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Ïù¥Ïä§ÌÑ∞ÏóêÍ∑∏: Ïö¥ÏÑù Ï∂©Îèå Ìö®Í≥º */
        #meteor-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; align-items: center; justify-content: center;
        }
        .meteor {
            width: 10px; height: 10px; background: radial-gradient(circle, #fff, #ffcc00, #ff3333);
            border-radius: 50%; transform: scale(1);
            animation: impact 2.5s forwards cubic-bezier(0.6, 0.04, 0.98, 0.335);
        }
        @keyframes impact {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(50); opacity: 1; }
            80% { transform: scale(200); background: #fff; opacity: 1; } 
            100% { transform: scale(500); background: #fff; opacity: 1; }
        }
        .shake-body { animation: violent-shake 0.1s infinite; }
        @keyframes violent-shake {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-10px, 10px); }
            50% { transform: translate(10px, -10px); }
            75% { transform: translate(-10px, -10px); }
            100% { transform: translate(0, 0); }
        }

        /* MODALS */
        #rank-open-btn { position: absolute; top: 0; left: 0; font-size: 1.2rem; padding: 5px 10px; border: 1px solid var(--main-color); display: block; }

        .modal-overlay {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: auto; padding: 20px; background: var(--bg-color); border: 2px solid var(--main-color);
            z-index: 2000; flex-direction: column; text-align: center; box-shadow: 0 0 30px #000;
        }
        .rank-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .rank-tab { font-size: 1.2rem; border-bottom: 1px solid transparent; opacity: 0.5; }
        .rank-tab.active { opacity: 1; border-bottom: 1px solid var(--main-color); font-weight: bold; }
        .rank-table { width: 100%; border-collapse: collapse; font-size: 1.2rem; margin-top: 10px; }
        .rank-table th { border-bottom: 1px solid var(--main-color); padding: 5px; text-align: center; }
        .rank-table td { padding: 5px; text-align: center; }
        .rank-user { color: #fff; text-shadow: 0 0 5px #fff; }

        #reset-confirm-modal { border-color: #ff3333; color: #ff3333; }
        .modal-btns { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }

        /* Phase Screens */
        #screen-phase1, #screen-phase2, #screen-phase3, #screen-end { display: none; width: 100%; text-align: center; }
        
        .question-text { font-size: 2rem; min-height: 80px; margin-bottom: 30px; }
        .result-bar-bg { width: 100%; height: 20px; background: #111; border: 1px solid var(--main-color); margin-top: 20px; display: none; }
        .result-bar-fill { height: 100%; background: var(--main-color); width: 0%; transition: width 0.5s; }
        .code-box { font-size: 4rem; letter-spacing: 15px; margin: 20px 0; border: 2px dashed var(--main-color); padding: 20px; }
        .hack-input { background: transparent; border: none; border-bottom: 3px solid var(--main-color); color: var(--main-color); font-size: 2.5rem; text-align: center; width: 80%; outline: none; text-transform: uppercase; }
        .timer-bg { width: 100%; height: 10px; background: #330000; margin-top: 30px; }
        .timer-fill { width: 100%; height: 100%; background: #ff3333; }
        #screen-phase3 { height: 100%; position: relative; }
        canvas { border: 2px solid var(--main-color); background: #000; cursor: none; display: block; margin: 0 auto; transition: border-color 0.2s; }
        .survival-timer { font-size: 2rem; margin-bottom: 10px; color: var(--main-color); transition: color 0.2s; }
        #break-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-align: center; font-size: 2rem; color: #fff; text-shadow: 0 0 10px #fff; display: none; pointer-events: none; }
        
        #screen-end { position: relative; height: 100%; }
        #end-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .end-content { position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .shine-text { font-size: 5rem; margin: 0; animation: shine 2s infinite alternate; }
        @keyframes shine { from { text-shadow: 0 0 10px var(--main-color); } to { text-shadow: 0 0 30px var(--main-color), 0 0 10px #fff; transform: scale(1.05); } }
        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        
        .shame-text { color: #ff3333; font-size: 1.5rem; margin-top: 10px; font-weight: bold; border: 1px dashed #ff3333; padding: 5px; display: inline-block;}
    </style>
</head>
<body class="mode-green">
    <div id="meteor-overlay"><div class="meteor"></div></div>

    <div class="scanline"></div>

    <div class="crt-frame" id="game-frame">
        <div class="header">
            <button id="rank-open-btn" onclick="openRanking()">üèÜ RANK</button>
            <div style="flex:1;"></div>
            <div style="text-align: right;">
                <span>LEVEL: <span id="stage-display">WAITING</span></span><br>
                <span>STATUS: <span id="status-display">OK</span></span>
            </div>
        </div>

        <div class="content-area">
            <div id="screen-start" style="text-align: center;">
                <h1 style="font-size: 3rem;">THE MINORITY</h1>
                <p>ÏµúÏ¢Ö ÌÖåÏä§Ìä∏Î•º ÏãúÏûëÌï©ÎãàÎã§.</p>
                <button onclick="startPhase1()" class="blink">SYSTEM START</button>
                <br>
                <button id="nightmare-btn" onclick="startNightmare()">‚ò† NIGHTMARE ‚ò†</button>
            </div>

            <div id="screen-phase1">
                <div class="question-text" id="p1-text"></div>
                <div id="p1-btns" style="display: flex; gap: 20px; justify-content: center;">
                    <button onclick="checkP1(true)">[Y] AGREE</button>
                    <button onclick="checkP1(false)">[N] DISAGREE</button>
                </div>
                <div id="p1-result">
                    <div class="result-bar-bg" id="bar-bg"><div class="result-bar-fill" id="bar-fill"></div></div>
                    <p id="p1-msg" style="margin-top:15px; height: 30px;"></p>
                    <button id="next-btn" onclick="nextPhase1()" style="display:none; width:100%;">NEXT >></button>
                </div>
            </div>

            <div id="screen-phase2">
                <h2 class="blink" style="color: #ff3333;">‚ö† SECURITY BREACH ‚ö†</h2>
                <div class="code-box" id="p2-code">????</div>
                <input type="text" class="hack-input" id="p2-input" placeholder="TYPE CODE" onkeyup="checkP2(event)" autocomplete="off">
                <div class="timer-bg"><div class="timer-fill" id="p2-timer"></div></div>
                <p id="p2-info">DEFENSE: 0 / 3</p>
            </div>

            <div id="screen-phase3">
                <div class="survival-timer">TIME: <span id="dodge-timer">READY</span></div>
                <div style="position: relative;">
                    <canvas id="gameCanvas" width="600" height="350"></canvas>
                    <div id="break-overlay"></div>
                </div>
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">MOUSE MOVE / AVOID OBJECTS</p>
            </div>

            <div id="screen-end">
                <canvas id="end-canvas"></canvas>
                <div class="end-content">
                    <h1 class="shine-text" id="end-title">ALL CLEAR</h1>
                    <p id="end-desc" style="font-size: 1.5rem; margin-top: 20px;">...</p>
                    <div id="shame-display" style="display:none;" class="shame-text"></div>
                    <div style="margin-top: 30px;">
                        <button id="reboot-btn" onclick="location.reload()">SYSTEM REBOOT</button>
                        <button id="skip-btn" onclick="skipToEnding()">>> SKIP >></button>
                        <button id="reset-btn" onclick="openResetModal()">‚ôªÔ∏è RESET STATS</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="rank-modal" class="modal-overlay">
            <h2 style="text-align: center; margin: 0 0 20px 0;">GLOBAL LEADERBOARD</h2>
            <div class="rank-tabs"><button class="rank-tab active" id="tab-legend" onclick="showRank('legend')">LEGEND</button><button class="rank-tab" id="tab-god" onclick="showRank('god')">GOD</button></div>
            <div style="flex:1; overflow-y: auto;"><table class="rank-table"><thead><tr><th width="15%">RANK</th><th width="40%">NAME</th><th width="25%">FAILS</th><th width="20%">DATE</th></tr></thead><tbody id="rank-tbody"></tbody></table></div>
            <button id="close-rank-btn" onclick="closeRanking()">CLOSE</button>
        </div>

        <div id="reset-confirm-modal" class="modal-overlay">
            <h2>‚ö† WARNING ‚ö†</h2>
            <p style="font-size: 1.3rem;">Ï†ïÎßê Ï¥àÍ∏∞Ìôî ÌïòÏãúÍ≤†ÏäµÎãàÍπå?</p>
            <p style="font-size: 1rem; color: #888;">Ï¥àÍ∏∞Ìôî Í∏∞Î°ùÏùÄ ÏòÅÏõêÌûà ÎÇ®ÏäµÎãàÎã§.</p>
            <div class="modal-btns"><button onclick="confirmReset(true)" style="border-color:#ff3333; color:#ff3333;">[Y] AGREE</button><button onclick="confirmReset(false)" style="border-color:#33ff33; color:#33ff33;">[N] DISAGREE</button></div>
        </div>
    </div>

    <script>
        /* ================= EASTER EGG: MICKEY ================= */
        const secretCode = "mickey";
        let inputKeys = "";

        window.addEventListener('keydown', (e) => {
            inputKeys += e.key.toLowerCase();
            if(inputKeys.length > secretCode.length) inputKeys = inputKeys.slice(-secretCode.length);
            
            if(inputKeys === secretCode) {
                triggerMeteorImpact();
                inputKeys = ""; // Ï§ëÎ≥µ Î∞©ÏßÄ
            }
        });

        function triggerMeteorImpact() {
            // 1. Ïö¥ÏÑù Ìö®Í≥º Î∞úÎèô
            const overlay = document.getElementById('meteor-overlay');
            overlay.style.display = 'flex'; // flexÎ°ú Ï§ëÏïô Ï†ïÎ†¨
            
            // 2. ÌôîÎ©¥ Ï†ÑÏ≤¥ ÌùîÎì§Í∏∞
            document.body.classList.add('shake-body');

            // 3. 2.5Ï¥à ÌõÑ (Ìè≠Î∞ú ÏãúÏ†ê) Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú Î∞è Î¶¨Î°úÎìú
            setTimeout(() => {
                localStorage.clear(); // Î™®Îì† Í∏∞Î°ù ÏÇ≠Ï†ú (ÌïòÎÇ®Ïûê Ìè¨Ìï®)
                location.reload();
            }, 2500);
        }

        /* ================= UTILS & LOCAL STORAGE ================= */
        function showScreen(id) {
            ['screen-start','screen-phase1','screen-phase2','screen-phase3','screen-end']
                .forEach(s => document.getElementById(s).style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if (id === 'screen-start') document.getElementById('rank-open-btn').style.display = 'block';
            else document.getElementById('rank-open-btn').style.display = 'none';
        }
        function setTheme(mode) { document.body.className = `mode-${mode}`; }

        let failCount = parseInt(localStorage.getItem('minority_fail_count')) || 0;
        let isGameCleared = localStorage.getItem('minority_game_cleared') === 'true';
        let resetUsedCount = parseInt(localStorage.getItem('minority_reset_used')) || 0; 
        let bestRecordNormal = parseInt(localStorage.getItem('minority_best_normal')) || 999;
        let bestRecordNightmare = parseInt(localStorage.getItem('minority_best_nightmare')) || 999;

        window.onload = function() {
            if (isGameCleared) document.getElementById('nightmare-btn').style.display = 'inline-block';
        };

        /* ================= RESET LOGIC ================= */
        function openResetModal() { document.getElementById('reset-confirm-modal').style.display = 'flex'; }
        function confirmReset(agree) {
            document.getElementById('reset-confirm-modal').style.display = 'none';
            if (agree) {
                failCount = 0; localStorage.setItem('minority_fail_count', 0);
                resetUsedCount++; localStorage.setItem('minority_reset_used', resetUsedCount);
                alert("Í∏∞Î°ùÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§. (ÏãúÏä§ÌÖúÏù¥ ÎãπÏã†Ïùò ÏÑ†ÌÉùÏùÑ Í∏∞ÏñµÌï©ÎãàÎã§.)"); location.reload();
            }
        }

        /* ================= RANKING ================= */
        const fakeDataNormal = [ { name: "DEV_KIM", attempts: 0, date: "2024.10" }, { name: "UNKNOWN_01", attempts: 2, date: "2024.11" }, { name: "PLAYER_X", attempts: 24, date: "2024.12" } ];
        const fakeDataNightmare = [ { name: "DEV_KIM", attempts: 3, date: "2024.10" }, { name: "GOD_GAMER", attempts: 7, date: "2024.11" } ];

        let currentRankTab = 'legend';
        function openRanking() { document.getElementById('rank-modal').style.display = 'flex'; showRank('legend'); }
        function closeRanking() { document.getElementById('rank-modal').style.display = 'none'; }
        function showRank(type) {
            currentRankTab = type; document.getElementById('tab-legend').className = (type === 'legend' ? 'rank-tab active' : 'rank-tab'); document.getElementById('tab-god').className = (type === 'god' ? 'rank-tab active' : 'rank-tab');
            let list = (type === 'legend') ? [...fakeDataNormal] : [...fakeDataNightmare];
            let userBest = (type === 'legend') ? bestRecordNormal : bestRecordNightmare;
            let userIncluded = false;
            if (userBest < 999) { list.push({ name: "YOU", attempts: userBest, date: "TODAY", isUser: true }); userIncluded = true; }
            list.sort((a, b) => a.attempts - b.attempts);
            const tbody = document.getElementById('rank-tbody'); tbody.innerHTML = "";
            if (list.length === 0 && !userIncluded) { tbody.innerHTML = "<tr><td colspan='4'>NO DATA</td></tr>"; return; }
            list.forEach((item, index) => { const tr = document.createElement('tr'); if (item.isUser) tr.className = "rank-user"; tr.innerHTML = `<td>${index + 1}</td><td>${item.name}</td><td>${item.attempts} FAILS</td><td>${item.date}</td>`; tbody.appendChild(tr); });
        }
        function saveRecord(isNightmare) {
            if (!isNightmare) { if (failCount < bestRecordNormal) { bestRecordNormal = failCount; localStorage.setItem('minority_best_normal', bestRecordNormal); } }
            else { if (failCount < bestRecordNightmare) { bestRecordNightmare = failCount; localStorage.setItem('minority_best_nightmare', bestRecordNightmare); } }
        }

        /* ================= GAME LOGIC ================= */
        let gameMode = 'normal'; let chaosModeActive = false; let frameVelocity = { x: 1.2, y: 1.2 }; let framePos = { x: 0, y: 0 }; 
        function startNightmare() { gameMode = 'nightmare'; startPhase3(); }

        const questions = [ { q: "ÎπÑ Ïò§Îäî ÎÇ†Ïù¥ ÎßëÏùÄ ÎÇ†Î≥¥Îã§ Ï¢ãÎã§.", rate: 80 }, { q: "10Ïñµ Î∞õÍ∏∞ vs ÎßêÌïòÎäî Í≥†ÏñëÏù¥ ÌÇ§Ïö∞Í∏∞", rate: 20 }, { q: "ÏÜîÏßÅÌûà ÌÉïÏàòÏú°ÏùÄ Î∂ÄÎ®πÏù¥Îã§.", rate: 45 } ];
        let p1Idx = 0;
        function startPhase1() { gameMode = 'normal'; showScreen('screen-phase1'); document.getElementById('stage-display').innerText = "1 - MINORITY"; renderP1(); }
        function renderP1() { const q = questions[p1Idx]; document.getElementById('p1-text').innerText = q.q; document.getElementById('p1-btns').style.display = 'flex'; document.getElementById('bar-bg').style.display = 'none'; document.getElementById('next-btn').style.display = 'none'; document.getElementById('p1-msg').innerText = ""; document.getElementById('bar-fill').style.width = "0%"; }
        function checkP1(agree) { const q = questions[p1Idx]; const rate = agree ? q.rate : (100 - q.rate); document.getElementById('p1-btns').style.display = 'none'; document.getElementById('bar-bg').style.display = 'block'; setTimeout(() => document.getElementById('bar-fill').style.width = rate + "%", 50); if (rate < 50) { document.getElementById('p1-msg').innerText = `ÏÉùÏ°¥. ÏÜåÏàò(${rate}%)ÏûÖÎãàÎã§.`; document.getElementById('next-btn').style.display = 'inline-block'; } else { failGame("MAJORITY DETECTED", "ÎãπÏã†ÏùÄ Îã§ÏàòÏóê ÏÜçÌñàÏäµÎãàÎã§."); } }
        function nextPhase1() { p1Idx++; if (p1Idx >= questions.length) startPhase2(); else renderP1(); }

        let p2Score = 0; let p2TimerInterval; let p2Time = 100;
        function startPhase2() { setTheme('red'); document.getElementById('stage-display').innerText = "2 - HACKING"; document.getElementById('status-display').innerText = "WARNING"; showScreen('screen-phase2'); nextP2(); }
        function nextP2() { if (p2Score >= 3) { clearInterval(p2TimerInterval); startPhase3(); return; } const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"; let code = ""; for(let i=0; i<4; i++) code += chars.charAt(Math.floor(Math.random()*chars.length)); document.getElementById('p2-code').innerText = code; document.getElementById('p2-input').value = ""; document.getElementById('p2-input').focus(); p2Time = 100; clearInterval(p2TimerInterval); p2TimerInterval = setInterval(() => { p2Time -= 1.5; document.getElementById('p2-timer').style.width = p2Time + "%"; if (p2Time <= 0) { clearInterval(p2TimerInterval); failGame("SYSTEM HACKED", "Î∞©ÌôîÎ≤ΩÏù¥ Îö´Î†∏ÏäµÎãàÎã§."); } }, 50); }
        function checkP2(e) { if (e.key === "Enter") { if (document.getElementById('p2-code').innerText === document.getElementById('p2-input').value.toUpperCase()) { p2Score++; document.getElementById('p2-info').innerText = `DEFENSE: ${p2Score} / 3`; nextP2(); } else { document.getElementById('p2-input').value = ""; } } }

        const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d'); let gameLoopId;
        let p3TotalTime = 45.00; let player = { x: 300, y: 175, size: 10, color: '#fff' }; let enemies = []; let warnings = []; let gameState = 'ready'; let currentPhase = 'green'; let countdownNum = 3;
        let typeWriterIdx = 0; let typeWriterText = ""; let typeWriterInterval;

        function startPhase3() { showScreen('screen-phase3'); enemies = []; warnings = []; gameState = 'ready'; countdownNum = 3; chaosModeActive = false; const frame = document.getElementById('game-frame'); frame.style.position = 'relative'; frame.style.left = 'auto'; frame.style.top = 'auto'; frame.classList.remove('chaos-shake'); document.body.style.display = 'flex'; if (gameMode === 'nightmare') { document.getElementById('stage-display').innerText = "‚ò† NIGHTMARE ‚ò†"; setTheme('nightmare'); p3TotalTime = 60.00; currentPhase = 'nightmare'; } else { document.getElementById('stage-display').innerText = "3 - SURVIVAL"; setTheme('green'); p3TotalTime = 45.00; currentPhase = 'green'; } document.getElementById('dodge-timer').innerText = "READY..."; document.getElementById('break-overlay').style.display = 'none'; canvas.addEventListener('mousemove', (e) => { const rect = canvas.getBoundingClientRect(); player.x = e.clientX - rect.left; player.y = e.clientY - rect.top; }); const countInterval = setInterval(() => { if (countdownNum > 0) { document.getElementById('dodge-timer').innerText = `START IN ${countdownNum}...`; countdownNum--; } else { clearInterval(countInterval); gameState = 'playing'; } }, 1000); if(gameLoopId) cancelAnimationFrame(gameLoopId); gameLoopId = requestAnimationFrame(gameLoop); }
        function startTyping(text) { const overlay = document.getElementById('break-overlay'); overlay.style.display = 'block'; overlay.innerText = ""; typeWriterText = text; typeWriterIdx = 0; clearInterval(typeWriterInterval); typeWriterInterval = setInterval(() => { if (typeWriterIdx < typeWriterText.length) { overlay.innerText += typeWriterText.charAt(typeWriterIdx); typeWriterIdx++; } else { clearInterval(typeWriterInterval); } }, 100); }
        function updateChaosFrame() { const frame = document.getElementById('game-frame'); if (!chaosModeActive) { chaosModeActive = true; const rect = frame.getBoundingClientRect(); framePos.x = rect.left; framePos.y = rect.top; document.body.style.display = 'block'; frame.style.position = 'absolute'; frame.style.margin = '0'; frame.style.left = framePos.x + 'px'; frame.style.top = framePos.y + 'px'; setTheme('chaos'); frame.classList.add('chaos-shake'); document.getElementById('status-display').innerText = "ERROR!!"; } framePos.x += frameVelocity.x; framePos.y += frameVelocity.y; if (framePos.x <= 0 || framePos.x + frame.offsetWidth >= window.innerWidth) frameVelocity.x *= -1; if (framePos.y <= 0 || framePos.y + frame.offsetHeight >= window.innerHeight) frameVelocity.y *= -1; frame.style.left = framePos.x + 'px'; frame.style.top = framePos.y + 'px'; }

        function gameLoop() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = (gameMode === 'nightmare') ? "#b026ff" : "#ffffff"; if(chaosModeActive) ctx.fillStyle = "#00ffea"; ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle; ctx.fillRect(player.x - player.size/2, player.y - player.size/2, player.size, player.size); ctx.shadowBlur = 0;
            if (gameState === 'ready') { ctx.fillStyle = "#ffffff"; ctx.font = "40px VT323"; ctx.textAlign = "center"; ctx.fillText(countdownNum > 0 ? countdownNum : "GO!", canvas.width/2, canvas.height/2); gameLoopId = requestAnimationFrame(gameLoop); return; }
            p3TotalTime -= 0.016; document.getElementById('dodge-timer').innerText = p3TotalTime.toFixed(2);
            if (gameMode === 'nightmare') { if (p3TotalTime <= 30) { updateChaosFrame(); } if (p3TotalTime <= 0) { cancelAnimationFrame(gameLoopId); gameClear(); return; } }
            else { let newPhase = currentPhase; if (p3TotalTime > 30) newPhase = 'green'; else if (p3TotalTime > 25) newPhase = 'break1'; else if (p3TotalTime > 10) newPhase = 'yellow'; else if (p3TotalTime > 5) newPhase = 'break2'; else if (p3TotalTime > 0) newPhase = 'red'; else { cancelAnimationFrame(gameLoopId); gameClear(); return; } if (newPhase !== currentPhase) { currentPhase = newPhase; if (currentPhase === 'break1') { setTheme('break'); enemies=[]; warnings=[]; startTyping("SYSTEM UPGRADE..."); } else if (currentPhase === 'break2') { setTheme('break'); enemies=[]; warnings=[]; startTyping("ÎãπÏã†ÏùÄ Í≥ºÏó∞ Ïù¥ Ïù¥ÏÉÅÏùÑ Íπ∞ Ïàò ÏûàÏùÑÍπå?"); } else if (currentPhase === 'green') { setTheme('green'); document.getElementById('break-overlay').style.display='none'; } else if (currentPhase === 'yellow') { setTheme('yellow'); document.getElementById('break-overlay').style.display='none'; } else if (currentPhase === 'red') { setTheme('red'); document.getElementById('break-overlay').style.display='none'; } } }
            if (!currentPhase.includes('break')) spawnPattern(currentPhase);
            for (let i = warnings.length - 1; i >= 0; i--) { let w = warnings[i]; w.timer--; if (w.timer > 0) { ctx.save(); ctx.beginPath(); ctx.setLineDash([10, 10]); let warnColor = "#ffcc00"; if(gameMode === 'nightmare') warnColor = "#b026ff"; if(chaosModeActive) warnColor = "#00ffea"; ctx.strokeStyle = (Math.floor(Date.now()/50)%2===0) ? warnColor : "#222"; ctx.lineWidth = 2; ctx.moveTo(w.x, 0); ctx.lineTo(w.x, canvas.height); ctx.stroke(); ctx.restore(); } else { let speed = (currentPhase === 'red') ? 6 : 5; if (gameMode === 'nightmare') speed = 5.5; let color = '#ff0000'; if (gameMode === 'nightmare') color = '#b026ff'; if (chaosModeActive) color = '#00ffea'; enemies.push({ x: w.x - (w.width/2), y: -50, size: w.width, speed: speed, type: 'blitz', color: color }); warnings.splice(i, 1); } }
            for (let i = 0; i < enemies.length; i++) { let e = enemies[i]; e.y += e.speed; ctx.fillStyle = e.color; let height = (e.type === 'blitz') ? canvas.height : e.size; ctx.fillRect(e.x, e.y, e.size, height); if (player.x < e.x + e.size && player.x + player.size > e.x && player.y < e.y + height && player.y + player.size > e.y) { cancelAnimationFrame(gameLoopId); failGame("KILLED", "ÏÉùÏ°¥Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§."); return; } }
            if (enemies.length > 50) enemies.shift();
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function spawnPattern(phase) {
            if (gameMode === 'nightmare') { let spawnRateWarn = 0.025; let spawnRateEnemy = 0.04; if (Math.random() < spawnRateWarn) warnings.push({ x: Math.random() * canvas.width, width: 30, timer: 90, active: true }); if (Math.random() < spawnRateEnemy) enemies.push({ x: Math.random() * canvas.width, y: -20, size: Math.random() * 15 + 10, speed: 4, type: 'normal', color: chaosModeActive ? '#00ffea' : '#b026ff' }); return; }
            if (phase === 'green') { if (Math.random() < 0.05) enemies.push({ x: Math.random() * canvas.width, y: -20, size: Math.random() * 15 + 10, speed: (Math.random() * 2 + 1), type: 'normal', color: '#33ff33' }); }
            else if (phase === 'yellow') { if (Math.random() < 0.04) warnings.push({ x: Math.random() * canvas.width, width: 25, timer: 90, active: true }); }
            else if (phase === 'red') { if (Math.random() < 0.05) warnings.push({ x: Math.random() * canvas.width, width: 30, timer: 100, active: true }); if (Math.random() < 0.08) enemies.push({ x: Math.random() * canvas.width, y: -20, size: Math.random() * 15 + 10, speed: (Math.random() * 2 + 2), type: 'normal', color: '#ff3333' }); }
        }

        function failGame(title, desc) { failCount++; localStorage.setItem('minority_fail_count', failCount); showScreen('screen-end'); setTheme('red'); document.getElementById('end-canvas').style.display = 'none'; document.getElementById('end-title').innerText = title; document.getElementById('end-title').className = "big-msg"; document.getElementById('end-title').style.color = "red"; document.getElementById('end-desc').innerText = desc; document.getElementById('shame-display').style.display = 'none'; if (failCount >= 5) document.getElementById('skip-btn').style.display = 'inline-block'; else document.getElementById('skip-btn').style.display = 'none'; clearInterval(p2TimerInterval); if(gameLoopId) cancelAnimationFrame(gameLoopId); }
        function skipToEnding() { localStorage.removeItem('minority_fail_count'); showScreen('screen-end'); setTheme('gray'); document.getElementById('end-canvas').style.display = 'none'; document.getElementById('skip-btn').style.display = 'none'; document.getElementById('end-title').innerText = "SKIPPED"; document.getElementById('end-title').className = "big-msg"; document.getElementById('end-title').style.color = "#888"; document.getElementById('end-desc').innerText = "ÌèâÎ≤îÌïú Í≤∞ÎßêÏûÖÎãàÎã§. Îã§Ïãú ÎèÑÏ†ÑÌïòÏãúÍ≤†ÏäµÎãàÍπå?"; }
        function gameClear() {
            saveRecord(gameMode === 'nightmare'); localStorage.removeItem('minority_fail_count'); failCount = 0; if (gameMode === 'normal') localStorage.setItem('minority_game_cleared', 'true');
            showScreen('screen-end'); document.getElementById('skip-btn').style.display = 'none'; document.getElementById('end-canvas').style.display = 'block'; const titleEl = document.getElementById('end-title'); const descEl = document.getElementById('end-desc'); const statusEl = document.getElementById('status-display'); const shameEl = document.getElementById('shame-display');
            if (resetUsedCount > 0) { setTheme('coward'); titleEl.innerText = "COWARD"; titleEl.style.color = "#cd853f"; descEl.innerText = "ÎãπÏã†ÏùÄ Í∏∞Î°ùÏùÑ ÏÑ∏ÌÉÅÌñàÏäµÎãàÎã§."; statusEl.innerText = "COWARD"; shameEl.style.display = 'inline-block'; shameEl.innerText = `RESET USED: ${resetUsedCount} TIMES`; }
            else { shameEl.style.display = 'none'; if (gameMode === 'nightmare') { setTheme('chaos'); titleEl.innerText = "GOD MODE"; titleEl.style.color = "#00ffea"; descEl.innerText = "ÎãπÏã†ÏùÄ ÏïÖÎ™ΩÏùÑ ÏßÄÎ∞∞ÌñàÏäµÎãàÎã§."; statusEl.innerText = "GOD"; } else { setTheme('clear'); titleEl.innerText = "ALL CLEAR"; titleEl.style.color = "#00ffff"; descEl.innerText = "Ï∂ïÌïòÌï©ÎãàÎã§. Î™®Îì† ÌÖåÏä§Ìä∏Î•º ÌÜµÍ≥ºÌñàÏäµÎãàÎã§."; statusEl.innerText = "LEGEND"; } }
            titleEl.className = "shine-text"; startFireworks();
        }

        let fireworks = [], particles = [], endCtx, endCanvas;
        function startFireworks() { endCanvas = document.getElementById('end-canvas'); endCtx = endCanvas.getContext('2d'); endCanvas.width = endCanvas.offsetWidth; endCanvas.height = endCanvas.offsetHeight; fireworks = []; particles = []; loopFireworks(); }
        function loopFireworks() {
            endCtx.clearRect(0, 0, endCanvas.width, endCanvas.height);
            if (Math.random() < 0.05) fireworks.push({ x: Math.random() * endCanvas.width, y: endCanvas.height, targetY: Math.random() * (endCanvas.height / 2), speed: 10 + Math.random() * 5, color: `hsl(${Math.random() * 360}, 100%, 50%)` });
            for (let i = fireworks.length - 1; i >= 0; i--) { let f = fireworks[i]; f.y -= f.speed; endCtx.fillStyle = f.color; endCtx.fillRect(f.x, f.y, 4, 10); if (f.y <= f.targetY) { explode(f.x, f.y, f.color); fireworks.splice(i, 1); } }
            for (let i = particles.length - 1; i >= 0; i--) { let p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.alpha -= 0.01; endCtx.save(); endCtx.globalAlpha = p.alpha; endCtx.fillStyle = p.color; endCtx.fillRect(p.x, p.y, 4, 4); endCtx.restore(); if (p.alpha <= 0) particles.splice(i, 1); }
            requestAnimationFrame(loopFireworks);
        }
        function explode(x, y, color) { for (let i = 0; i < 30; i++) { const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 5 + 2; particles.push({ x: x, y: y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, alpha: 1, color: color }); } }
    </script>
</body>
</html>
